<!DOCTYPE HTML>
<html>
  <head>
    <script src="js/jquery.min.js"></script>
    <style>
      body {
        margin: 0px;
        padding: 0px;
      }
    </style>
  </head>
  <body>
    <canvas id="myCanvas" width="800" height="600"></canvas>
    <button id="addCoin">Add Coin</button>
    <script>
      var CA = CA || {};

      CA.images = {};
      CA.images.coinImage = new Image();
      CA.images.coinImage.src = "image/coin-sprite-animation.png";


      function sprite (options) {
              
          var that = {},
              frameIndex = 0,
              tickCount = 0,
              ticksPerFrame = options.ticksPerFrame || 0,
              numberOfFrames = options.numberOfFrames || 1;

          that.context = options.context;
          that.width   = options.width;
          that.height  = options.height;
          that.image   = options.image;
          that.y       = options.y;
          that.x       = options.x;
          that.speed   = options.speed;
          that.sizeR   = options.sizeR;

          that.render = function () {

              // Draw the animation
              that.context.drawImage(
                 that.image,
                 frameIndex * that.width / numberOfFrames,
                 0,
                 that.width / numberOfFrames,
                 that.height,
                 that.x,
                 that.y,
                 (that.width / numberOfFrames)/this.sizeR,
                 (that.height)/this.sizeR);
          };
          that.loop = options.loop;
          that.update = function () {

              tickCount += 1;
            
              if (tickCount > ticksPerFrame) {
              
                tickCount = 0;
                
                // If the current frame index is in range
                if (frameIndex < numberOfFrames - 1) {  
                    // Go to the next frame
                    frameIndex += 1;
                } else if (that.loop) {
                    frameIndex = 0;
                }
              }
              this.y = this.y + this.speed;
          }; 
          return that;
      }


      var canvas  = document.getElementById("myCanvas"),
          context = canvas.getContext("2d"),
          items = [];

      var coin = {
          context: context,
          width: 1000,
          height: 100,
          image: CA.images.coinImage,
          numberOfFrames: 10,
          ticksPerFrame: 4,
          loop: 1,
          x: 0,
          y: 0
      };

      function renderView () {

        window.requestAnimationFrame(renderView);
        context.clearRect(0, 0, canvas.width, canvas.height);


        for(i=0;i<items.length;i++) {
          items[i].update();
          items[i].render();
        } 
      }

      // Start the game loop as soon as the sprite sheet is loaded
      //coinImage.addEventListener("load", gameLoop);

      renderView();

      $('document').ready(function(){
        $('#addCoin').on('click', function(){
            items.push(new sprite({
                context: context,
                width: 1000,
                height: 100,
                image: CA.images.coinImage,
                numberOfFrames: 10,
                ticksPerFrame: 4,
                loop: 1,
                speed: Math.floor(Math.random() * 4)+1,
                sizeR: Math.floor(Math.random() * 4)+1,
                x: Math.floor(Math.random() * 800),
                y: 0     
            }));
        });
      });
      // window.requestAnimFrame = (function(callback) {
      //   return window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || window.oRequestAnimationFrame || window.msRequestAnimationFrame ||
      //   function(callback) {
      //     window.setTimeout(callback, 1000 / 60);
      //   };
      // })();

      // function drawRectangle(myRectangle, context) {
      //   context.beginPath();
      //   context.rect(myRectangle.x, myRectangle.y, myRectangle.width, myRectangle.height);
      //   context.fillStyle = '#8ED6FF';
      //   context.fill();
      //   context.lineWidth = myRectangle.borderWidth;
      //   context.strokeStyle = 'black';
      //   context.stroke();
      // }


      // function animate(myRectangle, canvas, context, startTime) {
      //   // update
      //   var time = (new Date()).getTime() - startTime;

      //   var linearSpeed = 100;
      //   // pixels / second
      //   var newX = linearSpeed * time / 1000;

      //   if(newX < canvas.width - myRectangle.width - myRectangle.borderWidth / 2) {
      //     myRectangle.x = newX;
      //   }

      //   // clear
      //   context.clearRect(0, 0, canvas.width, canvas.height);

      //   drawRectangle(myRectangle, context);

      //   // request new frame
      //   requestAnimFrame(function() {
      //     animate(myRectangle, canvas, context, startTime);
      //   });
      // }
      // var canvas = document.getElementById('myCanvas');
      // var context = canvas.getContext('2d');

      // var myRectangle = {
      //   x: 0,
      //   y: 75,
      //   width: 100,
      //   height: 50,
      //   borderWidth: 5
      // };

      // drawRectangle(myRectangle, context);

      // // wait one second before starting animation
      // setTimeout(function() {
      //   var startTime = (new Date()).getTime();
      //   animate(myRectangle, canvas, context, startTime);
      // }, 1000);
    </script>
  </body>
</html>      